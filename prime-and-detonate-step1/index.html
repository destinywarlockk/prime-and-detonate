<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no" />
    <title>Prime & Detonate</title>
    <link rel="stylesheet" href="/src/style.css" />
  </head>
  <body>
    <!-- Wrap your game/app root -->
    <div id="app-wrap" class="fx-wrap">
      <div id="app" class="app-container"></div>
    </div>

    <!-- FX overlays -->
    <div id="fx-root">
      <div class="fx-layer fx-flash"></div>
      <div class="fx-layer fx-vignette"></div>
      <div class="fx-layer fx-invert"></div>
      <div class="fx-layer fx-ring-container"></div>
       <div class="fx-layer fx-floaters" id="fx-floaters"></div>
    </div>

    <style>
      :root{
        --fx-arc:#6fd1ff;
        --fx-thermal:#ff8a3a;
        --fx-void:#a477ff;
        --fx-kinetic:#e5f4ff;
        /* Damage floater palette */
        --dmg:#eaf0ff; --crit:#ffd54a; --heal:#45d07a; --shield:#7aa2ff;
        --elem-kin:#eaf0ff; --elem-arc:#6fd1ff; --elem-th:#ff8a3a; --elem-void:#a477ff;
      }
      
      /* iPhone viewport fixes */
      .fx-wrap{ 
        position: relative; 
        width: 100vw;
        max-width: 100vw;
        overflow: hidden;
        height: 100vh;
      }
      
      .app-container {
        width: 100%;
        max-width: 100vw;
        height: 100%;
        overflow: hidden;
        position: relative;
      }
      
      #fx-root{
        position:fixed; inset:0; pointer-events:none; z-index:9999;
        display:block;
      }
      .fx-layer{ position:absolute; inset:0; opacity:0; }
      .fx-flash{ background:radial-gradient(closest-side, rgba(255,255,255,.8), rgba(255,255,255,0) 60%); }
      .fx-vignette{
        background:radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,.45) 100%);
        mix-blend-mode:multiply;
      }
      .fx-invert{ background:#fff; mix-blend-mode:difference; opacity:0; transition:opacity 120ms ease-out; }

      /* Floating damage numbers */
      #fx-floaters{ position:absolute; inset:0; pointer-events:none; z-index:10000; opacity:1; }
      .fx-dmg{
        position:absolute; left:0; top:0; transform:translate(-50%,-50%) scale(.85);
        font-weight:800; font-size:18px; line-height:1;
        color:var(--dmg); text-shadow:0 2px 6px #000c;
        opacity:0; will-change:transform,opacity;
      }
      .fx-dmg.crit{ color:var(--crit); text-shadow:0 0 10px #000c, 0 0 12px rgba(255,213,74,.5); }
      .fx-dmg.heal{ color:var(--heal); }
      .fx-dmg.shield{ color:var(--shield); }
      .fx-dmg.arc{ color:var(--elem-arc); }
      .fx-dmg.thermal{ color:var(--elem-th); }
      .fx-dmg.void{ color:var(--elem-void); }

      @keyframes dmg-rise {
        0%   { opacity:0; transform:translate(var(--x,0), var(--y,0)) scale(.8); }
        15%  { opacity:1; transform:translate(var(--x,0), calc(var(--y,0) - 6px)) scale(1); }
        100% { opacity:0; transform:translate(var(--x,0), calc(var(--y,0) - 36px)) scale(1.05); }
      }
      @keyframes dmg-crit {
        0%   { opacity:0; transform:translate(var(--x,0), var(--y,0)) scale(.6) rotate(-2deg); }
        18%  { opacity:1; transform:translate(var(--x,0), calc(var(--y,0) - 4px)) scale(1.25) rotate(2deg); }
        100% { opacity:0; transform:translate(var(--x,0), calc(var(--y,0) - 48px)) scale(1.1) rotate(0); }
      }

      /* Prime/Detonate ring spawns as elements inside this container */
      .fx-ring{
        position:absolute; left:50%; top:50%; width:40vmin; height:40vmin;
        border-radius:50%;
        border:2px solid currentColor;
        box-shadow:0 0 18px currentColor, inset 0 0 10px currentColor;
        transform:translate(-50%,-50%) scale(0.6);
        opacity:.0;
      }

      @keyframes fx-pulse {
        0%   { transform:translate(-50%,-50%) scale(0.6); opacity:.0; }
        15%  { opacity:.8; }
        100% { transform:translate(-50%,-50%) scale(1.35); opacity:0; }
      }
      @keyframes fx-shockwave {
        0%   { transform:translate(-50%,-50%) scale(0.4); opacity:.0; filter:blur(2px); }
        10%  { opacity:.95; }
        100% { transform:translate(-50%,-50%) scale(2.2); opacity:0; filter:blur(6px); }
      }

      /* Reduce motion fallback */
      @media (prefers-reduced-motion: reduce){
        .fx-ring{ animation-duration:140ms !important; }
      }
    </style>

    <script>
      // iPhone viewport fixes
      function fixIPhoneViewport() {
        const isIPhone = /iPhone/.test(navigator.userAgent);
        const isIPad = /iPad/.test(navigator.userAgent);
        const isMobile = /Mobile/.test(navigator.userAgent);
        
        if (isIPhone || isIPad || isMobile) {
          // Force viewport constraints
          document.documentElement.style.width = '100vw';
          document.documentElement.style.maxWidth = '100vw';
          document.documentElement.style.overflowX = 'hidden';
          
          // Constrain body
          document.body.style.width = '100vw';
          document.body.style.maxWidth = '100vw';
          document.body.style.overflowX = 'hidden';
          
          // Constrain app container
          const appWrap = document.getElementById('app-wrap');
          const app = document.getElementById('app');
          
          if (appWrap) {
            appWrap.style.width = '100vw';
            appWrap.style.maxWidth = '100vw';
            appWrap.style.overflowX = 'hidden';
          }
          
          if (app) {
            app.style.width = '100%';
            app.style.maxWidth = '100vw';
            app.style.overflowX = 'hidden';
          }
          
          // Add touch-action for better mobile experience
          document.body.style.touchAction = 'manipulation';
          
          console.log('iPhone viewport fixes applied');
        }
      }
      
      // Apply fixes on load and resize
      window.addEventListener('load', fixIPhoneViewport);
      window.addEventListener('resize', fixIPhoneViewport);
      window.addEventListener('orientationchange', () => {
        setTimeout(fixIPhoneViewport, 100);
      });
      
      // Map element types -> tint color
      const FX_COLORS = {
        Arc: getComputedStyle(document.documentElement).getPropertyValue('--fx-arc').trim() || '#6fd1ff',
        Thermal: getComputedStyle(document.documentElement).getPropertyValue('--fx-thermal').trim() || '#ff8a3a',
        Void: getComputedStyle(document.documentElement).getPropertyValue('--fx-void').trim() || '#a477ff',
        Kinetic: getComputedStyle(document.documentElement).getPropertyValue('--fx-kinetic').trim() || '#e5f4ff'
      };

      const wrap = document.getElementById('app-wrap');
      const fxFlash = document.querySelector('.fx-flash');
      const fxVignette = document.querySelector('.fx-vignette');
      const fxRingRoot = document.querySelector('.fx-ring-container');
      const fxInvert = document.querySelector('.fx-invert');

      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      function lerp(a,b,t){ return a+(b-a)*t; }

      function shake(duration=160, px=8){
        if(prefersReduced) return;
        const t0 = performance.now();
        function step(t){
          const p = (t - t0) / duration;
          if(p >= 1){
            wrap.style.transform = 'translate3d(0,0,0)';
            return;
          }
          const damp = 1 - p; // ease out
          const dx = (Math.random()*2-1) * px * damp;
          const dy = (Math.random()*2-1) * px * damp;
          wrap.style.transform = `translate3d(${dx}px, ${dy}px, 0)`;
          requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }

      function flash(color='#fff', strength=1, ms=120){
        fxFlash.style.background = `radial-gradient(closest-side, ${hexA(color, 0.75*strength)}, rgba(255,255,255,0) 60%)`;
        fxFlash.style.transition = 'none';
        fxFlash.style.opacity = 1;
        requestAnimationFrame(()=>{
          fxFlash.style.transition = `opacity ${ms}ms ease-out`;
          fxFlash.style.opacity = 0;
        });
      }

      function flashSoft(color='#fff', strength=1, ms=200){
        fxFlash.style.background = `radial-gradient(closest-side, ${hexA(color, 0.25*strength)}, rgba(255,255,255,0) 70%)`;
        fxFlash.style.transition = 'none';
        fxFlash.style.opacity = 1;
        requestAnimationFrame(()=>{
          fxFlash.style.transition = `opacity ${ms}ms ease-out`;
          fxFlash.style.opacity = 0;
        });
      }

      function invertFlash(ms=140, amount=1){
        if(prefersReduced) return;
        if(!fxInvert) return;
        (fxInvert).style.transition = 'none';
        (fxInvert).style.opacity = String(Math.min(1, 0.85*amount));
        requestAnimationFrame(()=>{
          (fxInvert).style.transition = `opacity ${ms}ms ease-out`;
          (fxInvert).style.opacity = '0';
        });
      }

      function tintVignette(color='red', ms=240, amount=0.55){
        fxVignette.style.background =
          `radial-gradient(ellipse at center, rgba(0,0,0,0) 35%, ${hexA(color, amount)} 100%)`;
        fxVignette.style.transition = 'none';
        fxVignette.style.opacity = 1;
        requestAnimationFrame(()=>{
          fxVignette.style.transition = `opacity ${ms}ms ease-out`;
          fxVignette.style.opacity = 0;
        });
      }

      function spawnRing(color, kind='pulse', duration=420){
        const ring = document.createElement('div');
        ring.className = 'fx-ring';
        ring.style.color = color;
        ring.style.animation = `${kind === 'shock' ? 'fx-shockwave' : 'fx-pulse'} ${duration}ms ease-out forwards`;
        fxRingRoot.appendChild(ring);
        ring.addEventListener('animationend', ()=> ring.remove());
      }

      function zoomPulse(scale=0.985, ms=140){
        if(prefersReduced) return;
        wrap.style.transition = `transform ${ms}ms ease-out`;
        wrap.style.transform = `scale(${scale})`;
        setTimeout(()=>{
          wrap.style.transition = `transform ${ms*1.2}ms ease-out`;
          wrap.style.transform = 'scale(1)';
        }, ms);
      }

      function desaturate(ms=200, amt=0.6){
        if(prefersReduced) return;
        wrap.style.transition = `filter ${ms}ms ease-out`;
        wrap.style.filter = `saturate(${amt}) brightness(${lerp(1,0.92,1-amt)})`;
        setTimeout(()=>{ wrap.style.filter = 'none'; }, ms);
      }

      function hexA(hex, alpha){
        // accepts #rgb, #rrggbb
        const c = hex.replace('#','');
        const to255 = (s)=> parseInt(s.length===1?s+s:s,16);
        const r = to255(c.slice(0, c.length===3?1:2));
        const g = to255(c.slice(c.length===3?1:2, c.length===3?2:4));
        const b = to255(c.slice(c.length===3?2:4, c.length===3?3:6));
        return `rgba(${r},${g},${b},${alpha})`;
      }

      window.BattleFX = {
        hit(type='Kinetic', intensity=1){
          // Incoming damage: double invert flicker only
          invertFlash(120, intensity);
          setTimeout(()=> invertFlash(120, intensity), 90);
        },
        prime(type='Kinetic', intensity=1){
          const color = FX_COLORS[type] || FX_COLORS.Kinetic;
          spawnRing(color, 'pulse', 420);
          // soft element flash
          flashSoft(color, 0.7*intensity, 220);
        },
        detonate(type='Kinetic', intensity=1){
          const color = FX_COLORS[type] || FX_COLORS.Kinetic;
          // bright flash, shockwave ring, micro zoom
          flash('#ffffff', 0.9*intensity, 130);
          spawnRing(color, 'shock', 520);
          zoomPulse(0.985 - 0.01*intensity, 120);
        },
        explosion(type='Kinetic', intensity=1){
          const color = FX_COLORS[type] || FX_COLORS.Kinetic;
          // stronger combo: white flash + tinted flash, double shockwave, zoom and shake
          flash('#ffffff', 1.0*intensity, 140);
          setTimeout(()=> flash(color, 0.5*intensity, 160), 30);
          spawnRing(color, 'shock', 560);
          setTimeout(()=> spawnRing(color, 'shock', 680), 60);
          zoomPulse(0.972 - 0.012*intensity, 160);
          shake(220, 12*intensity);
        }
      };

      // ===== Floating Damage Numbers API =====
      (function(){
        function getCss(varName){
          return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
        }
        const DMG_COLORS = {
          Kinetic: getCss('--elem-kin') || '#eaf0ff',
          Arc:     getCss('--elem-arc') || '#6fd1ff',
          Thermal: getCss('--elem-th')  || '#ff8a3a',
          Void:    getCss('--elem-void')|| '#a477ff'
        };

        const floaterRoot = document.getElementById('fx-floaters');
        /** @type {HTMLCanvasElement|null} */
        let boundCanvas = null;

        function toClient(x, y){
          if(!boundCanvas){
            return { left: window.innerWidth/2, top: window.innerHeight/2 };
          }
          const r = boundCanvas.getBoundingClientRect();
          const cw = (/** @type {any} */(boundCanvas)).width || r.width;
          const ch = (/** @type {any} */(boundCanvas)).height || r.height;
          const sx = r.width / cw;
          const sy = r.height / ch;
          return { left: r.left + x * sx, top: r.top + y * sy };
        }

        function spawnFloater(pt, text, opts){
          const el = document.createElement('div');
          el.className = 'fx-dmg';
          el.textContent = text;

          if(opts && opts.crit) el.classList.add('crit');
          if(opts && opts.heal) el.classList.add('heal');
          if(opts && opts.shield) el.classList.add('shield');
          const t = (opts && opts.type ? String(opts.type) : '').toLowerCase();
          if(t==='arc') el.classList.add('arc');
          if(t==='thermal') el.classList.add('thermal');
          if(t==='void') el.classList.add('void');

          const jitterX = (Math.random()*18 - 9) | 0;
          const jitterY = (Math.random()*6 - 3) | 0;

          el.style.left = pt.left + 'px';
          el.style.top  = pt.top + 'px';
          el.style.setProperty('--x', jitterX+'px');
          el.style.setProperty('--y', jitterY+'px');

          el.style.animation = `${opts && opts.crit ? 'dmg-crit' : 'dmg-rise'} ${opts && opts.crit ? 680 : 520}ms ease-out forwards`;

          floaterRoot && floaterRoot.appendChild(el);
          el.addEventListener('animationend', ()=> el.remove());
        }

        if(!window.BattleFX) window.BattleFX = {};
        window.BattleFX.bindCanvas = function(canvasEl){ boundCanvas = canvasEl; };
        window.BattleFX.floatDamage = function(pos, value, opts){
          const v = Math.round(value);
          const label = (opts && opts.heal ? '+' : '') + (v === 0 ? 'MISS' : v.toString());
          const pt = toClient(pos.x, pos.y);
          spawnFloater(pt, label, opts || {});
        };
      })();
    </script>

    <!-- App entry -->
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
